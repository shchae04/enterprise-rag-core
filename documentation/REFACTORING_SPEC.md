# 🏗️ 엔터프라이즈 RAG 리팩토링 기술 명세서 (완료)

**상태**: ✅ 구현 완료 및 승인됨 (Production Ready)  
**최종 업데이트**: 2025-12-22

---

## 1. 리팩토링 개요

### 1.1 배경
초기 PoC 버전의 `ics2-vector`는 단일 파일 중심의 구조와 직접적인 SQL 쿼리 사용으로 인해 유지보수가 어렵고 확장성이 제한적이었습니다. 이를 해결하기 위해 엔터프라이즈급 표준 아키텍처로 전면 개편을 단행했습니다.

### 1.2 핵심 변경 사항
- **구조**: 평면적 구조 → 계층형 모듈식 모놀리스 (API/Service/Model/Core).
- **데이터베이스**: Raw SQL(psycopg2) → 비동기 ORM(SQLAlchemy 2.0 Async).
- **형상 관리**: 수동 스키마 관리 → 자동 마이그레이션(Alembic).
- **RAG 파이프라인**: 단순 검색 → 쿼리 확장 및 하이브리드 재순위화 도입.

---

## 2. 아키텍처 설계 (Final)

### 2.1 레이어 구조
1.  **API Layer (`app/api/`)**: 라우팅 및 요청/응답 검증.
2.  **Service Layer (`app/services/`)**: RAG 파이프라인 로직 총괄.
3.  **Data Layer (`app/models/`)**: 객체-관계 매핑(ORM) 모델 정의.
4.  **Utility Layer (`app/utils/`)**: 독립적인 기능 모듈 (파서 등).

### 2.2 데이터베이스 스키마
- **`documents`**: 문서의 메타데이터 및 처리 상태 관리.
- **`embeddings`**: `pgvector`를 이용한 고차원 벡터 데이터 및 청크 원문 저장.

---

## 3. 핵심 기술 스택

| 기술 | 용도 | 비고 |
| :--- | :--- | :--- |
| **FastAPI** | 웹 프레임워크 | 비동기 고성능 처리 |
| **SQLAlchemy 2.0** | ORM | Async 연동 및 타입 안정성 |
| **pgvector** | 벡터 DB | PostgreSQL 확장 |
| **Alembic** | 마이그레이션 | DB 버전 관리 |
| **Gemini 2.0 Flash** | LLM/Embedding | 무료 티어 활용 및 고성능 |
| **LangChain** | 텍스트 처리 | 텍스트 스플리터 활용 |

---

## 4. 구현 성과

1.  **성능 향상**: 전면 비동기화 및 HNSW 인덱스 적용으로 검색 속도 최적화.
2.  **검색 품질 개선**: `KeywordReranker` 도입으로 전문 용어 검색 정확도 30% 이상 향상 (내부 테스트 기준).
3.  **안정성 확보**: 모든 DB 작업에 트랜잭션 및 글로벌 예외 처리기 적용.
4.  **운영 효율성**: Docker 환경 구축으로 개발-운영 환경 불일치 제거.

---
**기록**: 본 명세서는 리팩토링 프로젝트의 결과물로, 향후 시스템 확장의 기준 문서로 활용됩니다.