name: RAG Vector CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      # 테스트용 DB 서비스 (pgvector 포함)
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # DB가 준비될 때까지 대기
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        # Install only core dependencies for CI (exclude heavy evaluation packages)
        pip install -r requirements.txt
        pip install pytest==8.3.0 pytest-asyncio==0.21.2 httpx==0.27.0 flake8==7.1.0
      timeout-minutes: 15

    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests
      env:
        # App 설정(app/core/config.py)은 DATABASE_URL이 아니라 DB_* env를 사용
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: postgres
        DB_PASSWORD: password
        DB_NAME: test_db
        # fork PR 등에서 secrets가 비어도 테스트가 돌 수 있게 더미 키를 사용
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'dummy' }}
        LLM_PROVIDER: gemini
      run: |
        set -euo pipefail
        # 빠른 유닛/스모크는 항상 실행
        pytest -m "not integration"

    - name: Run integration tests (main only)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: postgres
        DB_PASSWORD: password
        DB_NAME: test_db
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'dummy' }}
        LLM_PROVIDER: gemini
      run: |
        set -euo pipefail
        # integration 마커 테스트가 없으면(=collected 0) pytest exit code 5가 나올 수 있어 스킵 처리
        set +e
        pytest -m "integration" --collect-only -q
        code=$?
        set -e
        if [ "$code" -eq 5 ]; then
          echo "No integration tests found. Skipping..."
          exit 0
        fi
        if [ "$code" -ne 0 ]; then
          exit "$code"
        fi
        pytest -m "integration"

    - name: Run RAG Evaluation (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:password@localhost:5432/test_db
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # 평가는 main 브랜치에 푸시될 때만 실행 (Optional)
        # 무거운 패키지(ragas, datasets)는 별도로 설치
        echo "Skipping RAG evaluation in CI to reduce build time."
        echo "Run 'pip install -r requirements-dev.txt' and 'python tests/evaluation/evaluate_rag.py' locally for evaluation."
        # pip install ragas==0.1.0 datasets==2.20.0 langchain-openai==0.2.0
        # python tests/evaluation/evaluate_rag.py
